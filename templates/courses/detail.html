{% extends 'base.html' %}
{% block title %}Détail du cours - {{ course.titre }}{% endblock %}
{% block extra_css %}
<style>
    .course-detail-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        background: #fff;
    }
    .course-image {
        height: 220px;
        object-fit: cover;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(102,126,234,0.08);
    }
    .badge {
        font-size: 0.95rem;
        margin-right: 0.5em;
    }
    .course-meta {
        margin-bottom: 1rem;
    }
    .course-actions {
        margin-top: 1.5rem;
    }
    .resource-list li {
        margin-bottom: 1.2em;
    }
    .comment-list li {
        margin-bottom: 1.2em;
    }
</style>
{% endblock %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="course-detail-card">
                <div class="row">
                    <div class="col-md-5">
                        {% if course.image_couverture %}
                            <img src="{{ course.image_couverture.url }}" class="course-image mb-3" alt="Image de couverture">
                        {% else %}
                            <div class="course-image bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-play-circle fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-7">
                        <h2 class="mb-2">{{ course.titre }}</h2>
                        <div class="course-meta">
                            <span class="badge bg-primary">{{ course.get_niveau_display }}</span>
                            <span class="badge bg-secondary">{{ course.categorie }}</span>
                            {% if course.gratuit %}
                                <span class="badge bg-success">Gratuit</span>
                            {% else %}
                                <span class="badge bg-warning">{{ course.prix }} €</span>
                            {% endif %}
                            <span class="badge bg-info"><i class="fas fa-clock"></i> {{ course.duree_minutes }} min</span>
                        </div>
                        <p class="text-muted mb-2">{{ course.description }}</p>
                        <div class="mb-2">
                            <strong>Formateur :</strong> {{ course.formateur.utilisateur.get_full_name|default:course.formateur.utilisateur.prenom }}<br>
                            <strong>Date de création :</strong> {{ course.date_creation|date:"d/m/Y H:i" }}<br>
                            <strong>Mots-clés :</strong> {{ course.mots_cles }}<br>
                            <strong>Nombre d'inscrits :</strong> {{ course.nombre_inscrits }}<br>
                            <strong>Note moyenne :</strong> {{ avg_rating }} / 5 ({{ total_comments }} avis)<br>
                        </div>
                        <div class="course-actions d-flex gap-2">
                            <a href="{% url 'courses:watch' course.id %}" class="btn btn-success">
                                <i class="fas fa-play"></i> Commencer / Continuer
                            </a>
                            {% if is_admin or is_formateur or user.is_superuser or user.user_type == 'formateur' or user.user_type == 'administrateur' %}
                                <a href="{% url 'courses:edit' course.id %}" class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Modifier
                                </a>
                                <a href="{% url 'courses:delete' course.id %}" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Supprimer
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <hr>
                <h4 class="mt-4">Contenu du cours</h4>
                <div class="mb-3">{{ course.contenu|linebreaks }}</div>
                <h4 class="mt-4">Formations associées</h4>
                <ul>
                    {% for formation in course.formations.all %}
                        <li><a href="{% url 'formations:detail' formation.id %}">{{ formation.titre }}</a></li>
                    {% empty %}
                        <li>Aucune formation associée.</li>
                    {% endfor %}
                </ul>
                <h4 class="mt-4">Ressources du cours</h4>
                <ul class="resource-list">
                    {% for res in ressources %}
                        <li>
                            <strong>{{ res.titre }}</strong> <span class="badge bg-light text-dark">{{ res.get_type_ressource_display }}</span>
                            {% if res.type_ressource == 'video' and res.fichier %}
                                <video width="320" controls>
                                    <source src="{{ res.fichier.url }}" type="video/mp4">
                                    Votre navigateur ne supporte pas la vidéo.
                                </video>
                            {% elif res.type_ressource == 'document' and res.fichier %}
                                <a href="{{ res.fichier.url }}" target="_blank">Télécharger le document</a>
                            {% elif res.type_ressource == 'audio' and res.fichier %}
                                <audio controls>
                                    <source src="{{ res.fichier.url }}" type="audio/mpeg">
                                    Votre navigateur ne supporte pas l'audio.
                                </audio>
                            {% elif res.type_ressource == 'lien' and res.lien_externe %}
                                <a href="{{ res.lien_externe }}" target="_blank">Lien externe</a>
                            {% elif res.type_ressource == 'exercice' %}
                                <span>Exercice à compléter</span>
                            {% elif res.type_ressource == 'quiz' %}
                                <span>Quiz à compléter</span>
                            {% endif %}
                            <p>{{ res.description }}</p>
                        </li>
                    {% empty %}
                        <li>Aucune ressource disponible pour ce cours.</li>
                    {% endfor %}
                </ul>
                <h4 class="mt-4">Commentaires</h4>
                <ul class="comment-list">
                    {% for com in commentaires %}
                        <li>
                            <strong>{{ com.apprenant.utilisateur.get_full_name|default:com.apprenant.utilisateur.prenom }} </strong>
                            <span class="badge bg-info">Note : {{ com.note }}</span>
                            <span class="text-muted">({{ com.date_creation|date:"d/m/Y H:i" }})</span><br>
                            {{ com.commentaire|linebreaks }}
                        </li>
                    {% empty %}
                        <li>Aucun commentaire pour ce cours.</li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="course-enrollment-status">
                    {% if user_enrolled %}
                        <div class="alert alert-success">Vous êtes inscrit à ce cours.</div>
                        {% if user_progress %}
                            <strong>Progression :</strong> {{ user_progress.progression_pourcentage }}%<br>
                            <strong>Temps passé :</strong> {{ user_progress.temps_passe_minutes }} minutes<br>
                            {% if user_progress.termine %}
                                <span class="badge bg-success">Terminé</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">Vous n'êtes pas inscrit à ce cours.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
